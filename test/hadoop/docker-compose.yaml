version: '3.8'

services:
    postgres:
        hostname: postgres
        container_name: postgres
        image: postgres:16
        ports:
            - 5432:5432
        environment:
            PGUSER: pgadmin
            PGPASSWORD: pgadmin
            POSTGRES_USER: postgres-admin
            POSTGRES_PASSWORD: postgres-admin
            POSTGRES_DB: metastore_db
    hive-metastore:
        image: hive-base-img:v0
        hostname: hive-metastore
        container_name: hive-metastore
        depends_on:
            - namenode
            - postgres
        command: >
            /bin/bash -c "
            set -e;
            mkdir -p /workspace/hive/logs;
            schematool -dbType postgres -initSchema --verbose || echo 'Schema already initialized';
            hive --service metastore > /workspace/hive/logs/metastore.log 2>&1 &
            hive --service hiveserver2 --hiveconf hive.server2.thrift.bind.host=0.0.0.0 > /workspace/hive/logs/hiveserver2.log 2>&1 &
            tail -f /dev/null
            "
        ports:
            - 9083:9083
        volumes:
            - ../hive/conf/hive-site.xml:/workspace/hive/conf/hive-site.xml
            - ./config/common/hdfs-site.xml:/workspace/hadoop/etc/hadoop/hdfs-site.xml
            - ./config/common/core-site.xml:/workspace/hadoop/etc/hadoop/core-site.xml
            - ./config/common/mapred-site.xml:/workspace/hadoop/etc/hadoop/mapred-site.xml
            - ./config/common/yarn-site.xml:/workspace/hadoop/etc/hadoop/yarn-site.xml
    namenode:
        image: hive-base-img:v0
        hostname: namenode
        container_name: namenode
        command: ["/bin/bash", "-c", "if [ ! -d /workspace/hadoop/dfs/name/current ]; then hdfs namenode -format; fi && hdfs namenode"]
        ports:
            - 9870:9870
        volumes:
            - ./data/name-node:/workspace/hadoop/dfs/name
            - ./config/common/hdfs-site.xml:/workspace/hadoop/etc/hadoop/hdfs-site.xml
            - ./config/common/core-site.xml:/workspace/hadoop/etc/hadoop/core-site.xml
            - ./config/common/mapred-site.xml:/workspace/hadoop/etc/hadoop/mapred-site.xml
            - ./config/common/yarn-site.xml:/workspace/hadoop/etc/hadoop/yarn-site.xml
    datanode-nodemanager-1:
        image: hdfs-base-img:v0
        hostname: datanode-nodemanager-1
        container_name: datanode-nodemanager-1
        command: ["/bin/bash", "-c", "hdfs --daemon start datanode; yarn --daemon start nodemanager; sleep 3; tail -f /dev/null"]
        volumes:
            - ./config/common/hdfs-site.xml:/workspace/hadoop/etc/hadoop/hdfs-site.xml
            - ./config/common/core-site.xml:/workspace/hadoop/etc/hadoop/core-site.xml
            - ./config/common/mapred-site.xml:/workspace/hadoop/etc/hadoop/mapred-site.xml
            - ./config/common/yarn-site.xml:/workspace/hadoop/etc/hadoop/yarn-site.xml
    datanode-nodemanager-2:
        image: hdfs-base-img:v0
        hostname: datanode-nodemanager-2
        container_name: datanode-nodemanager-2
        command: ["/bin/bash", "-c", "hdfs --daemon start datanode; yarn --daemon start nodemanager; sleep 3; tail -f /dev/null"]
        volumes:
            - ./config/common/hdfs-site.xml:/workspace/hadoop/etc/hadoop/hdfs-site.xml
            - ./config/common/core-site.xml:/workspace/hadoop/etc/hadoop/core-site.xml
            - ./config/common/mapred-site.xml:/workspace/hadoop/etc/hadoop/mapred-site.xml
            - ./config/common/yarn-site.xml:/workspace/hadoop/etc/hadoop/yarn-site.xml
    resourcemanager:
        image: hdfs-base-img:v0
        hostname: resourcemanager
        container_name: resourcemanager
        command: ["/bin/bash", "-c", "yarn --daemon start resourcemanager && mapred --daemon start historyserver && tail -f /dev/null"]
        ports:
            - 8088:8088
            - 19888:19888
        volumes:
            - ./config/common/hdfs-site.xml:/workspace/hadoop/etc/hadoop/hdfs-site.xml
            - ./config/common/core-site.xml:/workspace/hadoop/etc/hadoop/core-site.xml
            - ./config/common/mapred-site.xml:/workspace/hadoop/etc/hadoop/mapred-site.xml
            - ./config/common/yarn-site.xml:/workspace/hadoop/etc/hadoop/yarn-site.xml